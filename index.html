
<!--
Machine Lifetime Tracker with Supabase Backend
Embed this in WordPress via a Custom HTML block.
-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Open+Sans:wght@700&display=swap" rel="stylesheet">

<div id="machine-lifetime-widget"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  
  :root {
    --color-black: #000000;
    --color-slate: #0F172A;
    --color-red: #E22627;
    --color-blue: #007EFF;
    --color-gray-bg: #E6ECEB;
    --color-red-light: #FFF2F2;
    --color-blue-light: #e0f2ff;
    --color-green-light: #dcfce7;
    --color-green-dark: #166534;
    --color-yellow-light: #fefce8;
    --color-yellow-dark: #854d0e;
  }

  #machine-lifetime-widget {
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    max-width: 980px;
    margin: 20px auto;
    border: 1px solid var(--color-gray-bg);
    padding: 18px;
    border-radius: 10px;
    background: #ffffff;
    box-shadow: 0 6px 20px rgba(16,24,40,0.04);
    color: var(--color-slate);
  }
  
  
  .mlw-row { display:flex; gap:14px; flex-wrap:wrap; }
  .mlw-col { flex:1; min-width:260px; }
  .mlw-title {
    font-family: 'Open Sans', sans-serif;
    font-size:18px;
    margin-bottom:6px;
    font-weight:700;
    color: var(--color-slate);
  }
  input, select, textarea {
    width:100%;
    padding:8px;
    margin:6px 0 12px 0;
    border:1px solid #d1d5db;
    border-radius:8px;
    box-sizing:border-box;
    font-size:14px;
    font-family: 'Inter', sans-serif;
  }
  button {
    padding:8px 12px;
    border-radius:8px;
    border:0;
    background: var(--color-blue);
    color:#fff;
    cursor:pointer;
    font-weight:600;
    font-family: 'Inter', sans-serif;
  }
  button.secondary {
    background: var(--color-gray-bg);
    color: var(--color-slate);
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .small { font-size:13px; color: var(--color-slate); opacity: 0.9; }
  .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#f3f4f6; }
  .canvas-wrap { margin:12px 0 18px 0; height:340px; }
  .maintenance-list {
    max-height:220px;
    overflow:auto;
    padding:8px;
    border:1px solid #f3f4f6;
    border-radius:8px;
    background:#fafafa;
  }
  .log-item { border-top:1px dashed #eee; padding:8px 0; }
  .info-line { margin:6px 0; color: var(--color-slate); }
  .notes { white-space:pre-wrap; color: var(--color-slate); opacity: 0.8; }
  .muted { color:#6b7280; font-size:13px; }
  .center { text-align:center; }
  .flex { display:flex; gap:8px; align-items:center; }
  .chip {
    background: var(--color-blue-light);
    padding:6px 10px;
    border-radius:999px;
    font-weight:600;
    color: var(--color-blue);
  }
  .inline-small { font-size:13px; color:#4b5563; }
  
  button.mlw_btn_del_log {
    font-size: 12px !important;
    padding: 2px 6px !important;
    background: var(--color-red) !important;
    color: white !important;
    border-radius: 6px !important;
  }
  
  .health-status {
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 700;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
  }
  .health-baik {
    background-color: var(--color-green-light);
    color: var(--color-green-dark);
  }
  .health-sederhana {
    background-color: var(--color-yellow-light);
    color: var(--color-yellow-dark);
  }
  .health-buruk {
    background-color: var(--color-red-light);
    color: var(--color-red);
  }
  
  .loading {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.6s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  (function () {
    // IMPORTANT: Replace these with your actual Supabase credentials
    const SUPABASE_URL = 'https://rrtcjmvqvcwzqchfrpna.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydGNqbXZxdmN3enFjaGZycG5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0OTk0NTIsImV4cCI6MjA3ODA3NTQ1Mn0.YHDGfY9dlzXzFPAQ7N5bROGl-OHRjkDB-Z6wOBVxq0E';
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ------------------ CONFIG ------------------
    const DAYS_IN_YEAR = 365;
    const TEN_YEARS_DAYS = 10 * DAYS_IN_YEAR;
    const SMOOTH_MONTHS = 6;
    const EFFECTS = { kendiri: 0.001, major: 0.01 };
    
    let currentUser = null;
    let machines = [];
    let currentMachine = null;
    let maintenances = [];
    
    // ------------------ UTIL ------------------
    function monthsBetween(a, b) {
      let A = new Date(a), B = new Date(b);
      if (A > B) [A, B] = [B, A];
      return (B.getFullYear() - A.getFullYear()) * 12 + (B.getMonth() - A.getMonth());
    }

    const root = document.getElementById("machine-lifetime-widget");

    // ------------------ SUPABASE HELPERS ------------------
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      return user;
    }

    async function loadUserMachines() {
      if (!currentUser) return [];
      const { data, error } = await supabase
        .from('machines')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('[v0] Error loading machines:', error);
        return [];
      }
      return data || [];
    }

    async function loadMachineMaintenance(machineId) {
      if (!currentUser) return [];
      const { data, error } = await supabase
        .from('maintenances')
        .select('*')
        .eq('machine_id', machineId)
        .eq('user_id', currentUser.id)
        .order('maintenance_date', { ascending: true });
      
      if (error) {
        console.error('[v0] Error loading maintenance:', error);
        return [];
      }
      return data || [];
    }

    // ------------------ RENDER ------------------
    async function render() {
      root.innerHTML = "";
      const user = await checkAuth();
      if (!user) return renderAuth();
      return renderApp();
    }

    // ---------- AUTH ----------
    function renderAuth() {
      const c = document.createElement("div");
      c.innerHTML = `
        <div class="mlw-title">Jangka Hayat Mesin — Log Masuk / Daftar</div>
        <div class="mlw-row">
          <div class="mlw-col">
            <div><strong>Log Masuk</strong></div>
            <div class="small">Gunakan email & password. Data disimpan dalam Supabase.</div>
            <input id="mlw_login_email" placeholder="Email" type="email"/>
            <input id="mlw_login_pass" placeholder="Password" type="password"/>
            <div style="display:flex;gap:8px;">
              <button id="mlw_btn_login">Log Masuk</button>
            </div>
            <div id="mlw_login_error" class="small" style="color: var(--color-red); margin-top: 8px;"></div>
          </div>
          <div class="mlw-col">
            <div><strong>Daftar Akaun Baru</strong></div>
            <div class="small">Daftar dengan email. Anda akan terima email pengesahan.</div>
            <input id="mlw_reg_email" placeholder="Email" type="email"/>
            <input id="mlw_reg_username" placeholder="Username (pilihan)" />
            <input id="mlw_reg_pass" placeholder="Password (min 6 characters)" type="password"/>
            <button id="mlw_btn_register" class="secondary">Daftar</button>
            <div id="mlw_reg_error" class="small" style="color: var(--color-red); margin-top: 8px;"></div>
          </div>
        </div>
      `;
      root.appendChild(c);

      document.getElementById("mlw_btn_login").onclick = async () => {
        const email = document.getElementById("mlw_login_email").value.trim();
        const password = document.getElementById("mlw_login_pass").value;
        const errorDiv = document.getElementById("mlw_login_error");
        const btn = document.getElementById("mlw_btn_login");
        
        if (!email || !password) {
          errorDiv.textContent = "Sila isi email dan password";
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Logging in...';
        errorDiv.textContent = "";
        
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });
        
        if (error) {
          errorDiv.textContent = `Error: ${error.message}`;
          btn.disabled = false;
          btn.textContent = "Log Masuk";
          return;
        }
        
        currentUser = data.user;
        render();
      };

      document.getElementById("mlw_btn_register").onclick = async () => {
        const email = document.getElementById("mlw_reg_email").value.trim();
        const username = document.getElementById("mlw_reg_username").value.trim();
        const password = document.getElementById("mlw_reg_pass").value;
        const errorDiv = document.getElementById("mlw_reg_error");
        const btn = document.getElementById("mlw_btn_register");
        
        if (!email || !password) {
          errorDiv.textContent = "Sila isi email dan password";
          return;
        }
        
        if (password.length < 6) {
          errorDiv.textContent = "Password mesti sekurang-kurangnya 6 characters";
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Registering...';
        errorDiv.textContent = "";
        
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: window.location.href,
            data: {
              username: username || email.split('@')[0]
            }
          }
        });
        
        if (error) {
          errorDiv.textContent = `Error: ${error.message}`;
          btn.disabled = false;
          btn.textContent = "Daftar";
          return;
        }
        
        alert("Akaun berjaya didaftar! Sila check email anda untuk pengesahan. Anda perlu verify email sebelum log masuk.");
        document.getElementById("mlw_reg_email").value = "";
        document.getElementById("mlw_reg_username").value = "";
        document.getElementById("mlw_reg_pass").value = "";
        btn.disabled = false;
        btn.textContent = "Daftar";
      };
    }

    // ---------- APP ----------
    async function renderApp() {
      machines = await loadUserMachines();
      
      const container = document.createElement("div");
      container.innerHTML = `
        <div class="mlw-row">
          <div class="mlw-col">
            <div class="mlw-title">Mesin Anda</div>
            <div class="small">Tambah mesin baru atau pilih mesin sedia ada.</div>
            <input id="mlw_machine_name" placeholder="Nama mesin (CMM / SMAW)" />
            <input id="mlw_machine_id" placeholder="Nombor ID mesin (unik)" />
            <label class="small">Tarikh pembelian:</label>
            <input id="mlw_purchase_date" type="date" />
            <div style="display:flex;gap:8px;">
              <button id="mlw_btn_add">Tambah / Simpan Mesin</button>
              <button id="mlw_btn_logout" class="secondary">Log Keluar</button>
            </div>
            <div style="margin-top:12px;">
              <label class="small">Mesin sedia ada</label>
              <select id="mlw_machine_select" style="width:100%;padding:8px;border-radius:8px;">
                <option value="">-- pilih mesin --</option>
              </select>
            </div>
          </div>

          <div class="mlw-col">
            <div class="mlw-title">Bantuan & Nota</div>
            <div class="small">
              - Jangka hayat asas: <strong>100% → 0% dalam 10 tahun</strong> (linear).<br/>
              - Penyelenggaraan <span class="badge">kendiri</span> menambah <strong>0.001%</strong> (per event).<br/>
              - Penyelenggaraan <span class="badge">major</span> menambah <strong>0.01%</strong> (per event).<br/>
              - Setiap maintenance effect diratakan masuk selama <strong>${SMOOTH_MONTHS} bulan</strong>.<br/>
            </div>
            <div style="margin-top:10px;">
              <button id="mlw_btn_gen_dummy" class="secondary">Generate Dummy Past Records</button>
              <div class="small info-line">Data disimpan di Supabase database.</div>
            </div>
          </div>
        </div>

        <div class="canvas-wrap"><canvas id="mlw_chart"></canvas></div>

        <div class="mlw-row">
          <div class="mlw-col">
            <div class="mlw-title">Maklumat Mesin</div>
            <div id="mlw_machine_info" class="small"></div>
          </div>

          <div class="mlw-col">
            <div class="mlw-title">Tambah Log Penyelenggaraan</div>
            <input id="mlw_log_date" type="date" />
            <input id="mlw_log_name" placeholder="Nama penyelenggara" />
            <select id="mlw_log_role">
              <option>Student</option>
              <option>Staff</option>
              <option>Technician</option>
            </select>
            <select id="mlw_log_type">
              <option value="kendiri">kendiri</option>
              <option value="major">major</option>
            </select>
            <textarea id="mlw_log_notes" placeholder="Maintenance done: apa yg diselenggarakan?" rows="3"></textarea>
            <div style="display:flex;gap:8px;">
              <button id="mlw_btn_add_log">Tambah Log</button>
              <button id="mlw_btn_clear_logs" class="secondary">Padam Semua Logs</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="mlw-title">Sejarah Penyelenggaraan (Bukti)</div>
          <div id="mlw_logs" class="maintenance-list small"></div>
        </div>
      `;
      root.appendChild(container);

      const select = document.getElementById("mlw_machine_select");
      function refreshMachineSelect() {
        select.innerHTML = '<option value="">-- pilih mesin --</option>';
        machines.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = `${m.name} — ${m.machine_id} (beli ${m.purchase_date})`;
          select.appendChild(opt);
        });
      }
      refreshMachineSelect();

      
      let chart = null;
      
      function baselinePercentAt(dateISO, purchaseISO, clampToZero = true) {
        const p = new Date(purchaseISO);
        const d = new Date(dateISO);
        if (d < p) return 100;
        const elapsed = d - p;
        const percent = 100 - (elapsed / (TEN_YEARS_DAYS * 24*3600*1000)) * 100;
        return clampToZero ? Math.max(0, percent) : percent;
      }

      function makeMonthlyLabels(purchaseISO, totalBoostPct = 0) {
        const start = new Date(purchaseISO);
        const extraDays = (totalBoostPct / 1) * (DAYS_IN_YEAR / 10);
        const end = new Date(
          start.getTime() +
            (TEN_YEARS_DAYS + DAYS_IN_YEAR + extraDays) * 24 * 3600 * 1000
        );
        const labels = [];
        const d = new Date(start.getTime());
        d.setDate(1);
        while (d <= end) {
          labels.push(d.toISOString().slice(0, 10));
          d.setMonth(d.getMonth() + 1);
        }
        return labels;
      }

      function computeSeries(machine, machineMaintenances) {
        const totalBoost = machineMaintenances.reduce((sum, m) => sum + (EFFECTS[m.maintenance_type] || 0), 0);
        const labels = makeMonthlyLabels(machine.purchase_date, totalBoost);
        
        const baseline = labels.map(l => baselinePercentAt(l, machine.purchase_date, true));
        const adjusted = labels.map(l => baselinePercentAt(l, machine.purchase_date, false));

        const maints = machineMaintenances.slice().sort((a,b) => a.maintenance_date.localeCompare(b.maintenance_date));
        
        const easeInOutSine = (x) => -(Math.cos(Math.PI * x) - 1) / 2;

        for (const m of maints) {
          const boost = EFFECTS[m.maintenance_type] || 0;
          const idx = labels.findIndex(l => l >= m.maintenance_date);
          if (idx === -1) continue;
          for (let j = idx; j < labels.length; j++) {
            const monthsSince = j - idx;
            let progress = Math.min(1, (monthsSince + 1) / SMOOTH_MONTHS);
            const factor = easeInOutSine(progress);
            adjusted[j] = Math.min(100, adjusted[j] + boost * factor);
          }
        }
        
        const finalAdjusted = adjusted.map(v => Math.max(0, v));

        const markers = maints.map(m => {
          let idx = labels.findIndex(l => l >= m.maintenance_date);
          if (idx === -1) idx = labels.length - 1;
          return { ...m, index: idx, y: finalAdjusted[idx] };
        });

        return { labels, baseline, adjusted: finalAdjusted, markers };
      }

      function drawChartFor(machine, machineMaintenances) {
        const canvas = document.getElementById("mlw_chart");
        if (!machine) {
          if (chart) { chart.destroy(); chart = null; }
          canvas.getContext("2d").clearRect(0,0,canvas.width, canvas.height);
          return;
        }
        
        const s = computeSeries(machine, machineMaintenances);
        if (chart) chart.destroy();
        const ctx = canvas.getContext("2d");

        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: s.labels,
            datasets: [
              {
                label: "Jangka Hayat Asas",
                data: s.baseline,
                fill: false,
                borderColor: "rgba(107,114,128,0.75)",
                borderDash: [5, 5], 
                pointRadius: 0,
                tension: 0, 
                borderWidth: 2
              },
              {
                label: "Tambahan Jangka Hayat",
                data: s.baseline.map((_, i) => i >= (12*10) ? 100 : null),
                fill: true,
                backgroundColor: "rgba(0, 126, 255, 0.05)", 
                borderWidth: 0,
                pointRadius: 0
              },
              {
                label: "Jangka Hayat Selepas Penyelenggaraan",
                data: s.adjusted, 
                fill: false,
                borderColor: "var(--color-blue)", 
                pointRadius: 2,
                tension: 0.4, 
                borderWidth: 2
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  autoSkip: false,
                  callback: function(val, idx) {
                    const total = this.getLabels().length;
                    if (idx === 0 || idx === total-1) return this.getLabelForValue(idx).slice(0,7);
                    if (idx % 12 === 0) return this.getLabelForValue(idx).slice(0,7);
                    return "";
                  }
                }
              },
              y: {
                min: 0,
                max: 100,
                ticks: { stepSize: 10, callback: (v)=> v + "%" }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                }
              },
              legend: { position: 'top' }
            }
          }
        });

        if (s.markers.length) {
          chart.data.datasets.push({
            type: 'scatter',
            label: 'Penyelenggaraan',
            data: s.markers.map(m => ({ x: s.labels[m.index], y: m.y, type: m.maintenance_type, date: m.maintenance_date })),
            pointStyle: s.markers.map(m => m.maintenance_type === 'major' ? 'triangle' : 'circle'),
            pointRadius: s.markers.map(m => m.maintenance_type === 'major' ? 6 : 4),
            backgroundColor: s.markers.map(m => m.maintenance_type === 'major' ? 'var(--color-red)' : 'rgba(16,185,129,0.9)'),
            showLine: false
          });
        }
        chart.update();
      }

      async function showMachineInfo(machineId) {
        const info = document.getElementById("mlw_machine_info");
        const logsDiv = document.getElementById("mlw_logs");
        
        if (!machineId) {
          info.innerHTML = '<div class="small">Pilih mesin untuk lihat jangka hayat, tarikh beli, dan logs.</div>';
          logsDiv.innerHTML = '';
          drawChartFor(null, []);
          return;
        }
        
        const machine = machines.find(m => m.id === machineId);
        if (!machine) return;
        
        maintenances = await loadMachineMaintenance(machineId);
        
        const purchase = new Date(machine.purchase_date);
        const eol = new Date(purchase.getTime() + TEN_YEARS_DAYS * 24*3600*1000);
        const eolISO = eol.toISOString().slice(0,10);
        const todayISO = new Date().toISOString().slice(0,10);
        
        const baselineNow = baselinePercentAt(todayISO, machine.purchase_date, true);
        
        let healthBoostNow = 0;
        const easeInOutSine = (x) => -(Math.cos(Math.PI * x) - 1) / 2;
        maintenances.forEach(mm => {
            if (mm.maintenance_date <= todayISO) {
                const boost = EFFECTS[mm.maintenance_type] || 0;
                const monthsSince = monthsBetween(mm.maintenance_date, todayISO);
                let progress = Math.min(1, (monthsSince + 1) / SMOOTH_MONTHS);
                const factor = easeInOutSine(progress);
                healthBoostNow += boost * factor;
            }
        });

        const rawBaselineNow = baselinePercentAt(todayISO, machine.purchase_date, false);
        const adjustedNow = Math.min(100, Math.max(0, rawBaselineNow + healthBoostNow));

        const totalBoostAllTime = maintenances.reduce((sum, mm) => sum + (EFFECTS[mm.maintenance_type] || 0), 0);
        const yearsExtended = totalBoostAllTime / 10; 
        const eolAdjusted = new Date(eol.getTime() + yearsExtended * DAYS_IN_YEAR * 24 * 3600 * 1000);
        const eolAdjustedISO = eolAdjusted.toISOString().slice(0,10);
        
        let healthStatus = '';
        let healthClass = '';
        const sortedMaints = maintenances.slice().sort((a,b) => b.maintenance_date.localeCompare(a.maintenance_date));
        const lastMaint = sortedMaints.length > 0 ? sortedMaints[0].maintenance_date : null;
        const monthsSinceLastMaint = lastMaint ? monthsBetween(lastMaint, todayISO) : 999;

        if (monthsSinceLastMaint <= 1) {
            healthStatus = 'Baik';
            healthClass = 'health-baik';
        } else if (monthsSinceLastMaint < 6) {
            healthStatus = 'Sederhana (Perlu Penyelenggaraan Kendiri)';
            healthClass = 'health-sederhana';
        } else {
            healthStatus = 'Buruk (Perlu Penyelenggaraan Major)';
            healthClass = 'health-buruk';
        }
        
        info.innerHTML = `
          <div class="health-status ${healthClass}">
            Status Kesihatan Mesin ${machine.name}: <strong>${healthStatus}</strong>
          </div>
          <div class="info-line" style="margin-top: 10px;"><strong>Nama:</strong> ${machine.name}</div>
          <div><strong>ID Mesin:</strong> ${machine.machine_id}</div>
          <div class="info-line"><strong>Tarikh Beli:</strong> ${machine.purchase_date}</div>
          <div class="info-line"><strong>Jangka hayat tamat (base):</strong> ${eolISO} (10 tahun selepas pembelian)</div>
          <div class="info-line"><strong>Jangka hayat asas hari ini:</strong> ${baselineNow.toFixed(4)}%</div>
          <div class="info-line"><strong>Jangka hayat (diselenggara) hari ini:</strong> ${adjustedNow.toFixed(4)}%</div>
          <div class="info-line" style="background-color: var(--color-blue-light); color: var(--color-blue); font-weight: 600; padding: 6px 10px; border-radius: 6px;">
            <strong>Tarikh jangka hayat dijangka tamat (setelah diselenggara):</strong> ${eolAdjustedISO}
          </div>
        `;

        logsDiv.innerHTML = "";
        if (!sortedMaints.length) {
          logsDiv.innerHTML = '<div class="small muted">Tiada rekod penyelenggaraan.</div>';
        } else {
          for (const mm of sortedMaints) {
            const item = document.createElement("div");
            item.className = "log-item";
            
            const boostPct = EFFECTS[mm.maintenance_type] || 0;
            const boostDays = (boostPct / 10 * DAYS_IN_YEAR).toFixed(2);

            item.innerHTML = `
              <div class="flex" style="justify-content: space-between; align-items: flex-start;">
                <div>
                  <strong>${mm.maintenance_date}</strong> <span class="muted">[Log ID: ${mm.id}]</span> — <span class="badge">${mm.maintenance_type}</span> by ${mm.maintainer_name} (${mm.maintainer_role})
                  <div class="notes small" style="margin-top: 4px;">${mm.notes || 'Tiada nota'}</div>
                </div>
                <div class="chip" style="font-size: 12px; flex-shrink: 0; margin-left: 8px;">+${boostPct.toFixed(3)}% (+${boostDays} hari)</div>
              </div>
              <div style="margin-top:6px;">
                <button class="mlw_btn_del_log" data-id="${mm.id}">Padam</button>
              </div>
            `;
            
            logsDiv.appendChild(item);
          }
        }
        
        Array.from(logsDiv.querySelectorAll('.mlw_btn_del_log')).forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Padam log ini?")) return;
            
            const { error } = await supabase
              .from('maintenances')
              .delete()
              .eq('id', id)
              .eq('user_id', currentUser.id);
            
            if (error) {
              alert(`Error: ${error.message}`);
              return;
            }
            
            await showMachineInfo(machineId);
          };
        });
        
        drawChartFor(machine, maintenances);
      }

      // ---------- EVENTS ----------
      document.getElementById("mlw_btn_add").onclick = async () => {
        const name = document.getElementById("mlw_machine_name").value.trim();
        const mid = document.getElementById("mlw_machine_id").value.trim();
        const pdate = document.getElementById("mlw_purchase_date").value;
        const btn = document.getElementById("mlw_btn_add");
        
        if (!name || !mid || !pdate) {
          alert("Sila isi semua maklumat mesin");
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Saving...';
        
        const { data, error } = await supabase
          .from('machines')
          .upsert({
            machine_id: mid,
            name: name,
            purchase_date: pdate,
            user_id: currentUser.id
          }, {
            onConflict: 'user_id,machine_id'
          })
          .select()
          .single();
        
        btn.disabled = false;
        btn.textContent = "Tambah / Simpan Mesin";
        
        if (error) {
          alert(`Error: ${error.message}`);
          return;
        }
        
        machines = await loadUserMachines();
        refreshMachineSelect();
        select.value = data.id;
        await showMachineInfo(data.id);
        alert("Mesin disimpan");
      };

      select.onchange = async function() {
        const machineId = this.value;
        await showMachineInfo(machineId);
        document.getElementById("mlw_log_date").value = new Date().toISOString().slice(0,10);
      };

      document.getElementById("mlw_btn_gen_dummy").onclick = async () => {
        const machineId = select.value;
        if (!machineId) {
          alert("Pilih mesin dahulu untuk generate dummy records");
          return;
        }
        
        const machine = machines.find(m => m.id === machineId);
        const start = new Date(machine.purchase_date);
        const today = new Date();
        const end = new Date(Math.min(today.getTime(), start.getTime() + TEN_YEARS_DAYS * 24*3600*1000));
        const items = [];
        const d = new Date(start.getTime());
        
        while (d <= end) {
          const iso = d.toISOString().slice(0,10);
          items.push({
            machine_id: machineId,
            user_id: currentUser.id,
            maintenance_date: iso,
            maintainer_name: "Auto Demo",
            maintainer_role: "Student",
            maintenance_type: "kendiri",
            notes: "Auto monthly kendiri"
          });
          
          const monthsSinceStart = monthsBetween(start.toISOString().slice(0,10), d.toISOString().slice(0,10));
          if (monthsSinceStart > 0 && monthsSinceStart % 6 === 0) { 
            items.push({
              machine_id: machineId,
              user_id: currentUser.id,
              maintenance_date: iso,
              maintainer_name: "Auto Demo",
              maintainer_role: "Technician",
              maintenance_type: "major",
              notes: "Auto semiannual major"
            });
          }
          d.setMonth(d.getMonth() + 1);
        }
        
        const { error } = await supabase
          .from('maintenances')
          .insert(items);
        
        if (error) {
          alert(`Error: ${error.message}`);
          return;
        }
        
        await showMachineInfo(machineId);
        alert("Dummy past records generated!");
      };

      document.getElementById("mlw_btn_add_log").onclick = async () => {
        const machineId = select.value;
        if (!machineId) {
          alert("Pilih mesin dahulu");
          return;
        }
        
        const date = document.getElementById("mlw_log_date").value;
        const name = document.getElementById("mlw_log_name").value.trim();
        const role = document.getElementById("mlw_log_role").value;
        const type = document.getElementById("mlw_log_type").value;
        const notes = document.getElementById("mlw_log_notes").value.trim();
        const btn = document.getElementById("mlw_btn_add_log");
        
        if (!date || !name) {
          alert("Sila isi tarikh dan nama penyelenggara");
          return;
        }
        
        const machine = machines.find(m => m.id === machineId);
        if (date < machine.purchase_date) {
          alert(`Tarikh log (${date}) tidak boleh sebelum tarikh pembelian mesin (${machine.purchase_date}).`);
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Adding...';
        
        const { error } = await supabase
          .from('maintenances')
          .insert({
            machine_id: machineId,
            user_id: currentUser.id,
            maintenance_date: date,
            maintainer_name: name,
            maintainer_role: role,
            maintenance_type: type,
            notes: notes || null
          });
        
        btn.disabled = false;
        btn.textContent = "Tambah Log";
        
        if (error) {
          alert(`Error: ${error.message}`);
          return;
        }
        
        document.getElementById("mlw_log_name").value = "";
        document.getElementById("mlw_log_notes").value = "";
        await showMachineInfo(machineId);
      };

      document.getElementById("mlw_btn_clear_logs").onclick = async () => {
        const machineId = select.value;
        if (!machineId) {
          alert("Pilih mesin dahulu");
          return;
        }
        
        if (!confirm("Padam semua logs untuk mesin ini?")) return;
        
        const { error } = await supabase
          .from('maintenances')
          .delete()
          .eq('machine_id', machineId)
          .eq('user_id', currentUser.id);
        
        if (error) {
          alert(`Error: ${error.message}`);
          return;
        }
        
        await showMachineInfo(machineId);
      };

      document.getElementById("mlw_btn_logout").onclick = async () => {
        if (!confirm("Log keluar?")) return;
        await supabase.auth.signOut();
        currentUser = null;
        render();
      };

      if (machines.length > 0) {
        select.value = machines[0].id;
        await showMachineInfo(machines[0].id);
      } else {
        await showMachineInfo(null);
      }
    }

    render();
  })();
</script>
